# Инструкции для AGENTS

## Базовые принципы
- Соблюдаем SOLID и KISS: простая архитектура, минимальные зависимости.
- Приоритет: локально простой стек (Next.js App Router, TypeScript, Tailwind, shadcn/ui, Prisma+SQLite, Zod, React Hook Form, TanStack Table, Recharts).
- Денежные суммы только в `amountCents` (целые числа), даты в ISO с явным часовым поясом.
- Не храним секреты на клиенте; ключи ИИ — только сервер.
- Чистим мёртвый код и следуем паттернам проекта.

## Продуктовые истины (обязательно)
- Самая сложная часть — парсинг/нормализация PDF; банк-форматы различаются, LLM может ошибаться.
- Никогда не считаем финансовые итоги из вывода LLM — только детерминированный код по валидированным транзакциям.
- Каждая транзакция аудируема: сырой текст/строка, распарсенные поля, доверие, ручные правки.
- UX «review & fix» с первого дня: таблица редактирования, переименование мерчанта, override категории.
- Если есть сомнения — запросить примеры из фикстур и предложить тесты прежде чем менять логику.

## Домен и данные
- Транзакции: `amountCents` со знаковым целым (единый выбор знака для расходов), обязательная `currency`.
- Сохраняем `originalDescription`; `normalizedMerchant` редактируемый; `category` всегда задана после ревью (фолбэк «Uncategorized»).
- Источник обязателен: `statementId/importId` + `rawLine/page` + `extractedTextHash`.
- Бюджеты: `plannedIncomeCents` в месяц, `categoryBudgets` по категориям. Ручные правки переживают переимпорт.
- Не вычислять аналитику на непроверенной схеме. Не перетирать ручные правки без явного merge.

## Импорт PDF
- Шаги: извлечь текст → если пусто/шум — пометить «needs OCR» и остановиться (не угадывать) → детерминированные эвристики/регексы по банку → LLM только для JSON-транзакций и нормализаций → валидация Zod (форматы, диапазоны, даты) → экран Review Table перед коммитом.
- Парсеры по формату банка (bank-id), подключаемые; хранить фикстуры (extracted text + ожидаемый парс).

## LLM-контракты (жёстко)
- Вызовы LLM только на сервере. Строгий JSON по схеме, без прозы.
- Сохраняем: версию промпта, модель, сырой ответ, разобранный JSON, ошибки валидации, доверие на транзакцию; низкое доверие требует ручного ревью.
- Не доверять LLM для итогов. Контроль стоимости: чанк по страницам/секциям, ограничивать токены, кэш по `extractedTextHash`.
- Конфиденциальность: банковские данные чувствительны, логи по умолчанию редактированы; не логировать полный текст.

## UI/UX
- Оптимизация скорости ревью: клавиатурная таблица, массовое применение категории, undo.
- Всегда показывать происхождение: строка/страница источника, доверие, кто и когда правил.
- Фокусные экраны: Import & Review, Monthly Dashboard, Budgets, Rules (алиасы/правила категорий).
- Использовать shadcn примитивы и их a11y по умолчанию.

## Тестирование и фикстуры
- Golden-файлы: `extracted-text/*.txt`, `expected-transactions/*.json`.
- Юнит-тесты: парсинг/эвристики, нормализация денег/дат, merge логика ручных правок.
- Интеграция: import → review → commit → dashboard totals.
- Любая найденная баговая выписка становится фикстурой + тестом.

## Безопасность
- Ключи AI — только серверные env. Загрузка: лимиты размера, типы, хранение вне публичных путей.
- Логи без полного текста выписки; рассмотреть шифрование PDF при синке.


